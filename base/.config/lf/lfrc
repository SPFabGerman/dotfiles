source ~/.config/lf/common_init.lf

# Previewer
set preload false
set previewer ctpv
set cleaner ctpvclear
&ctpv -s $id
# This is more responsive than the included ctpvquit, which only acts after a small delay
cmd on-quit &ctpv -e $id

# Movement
map j jump
map <c-s> search-deep
map F filter-interactive
map n next-dir
map N prev-dir

# create new files and directories
map c
map cf push :create-file<space>
map cd push :create-dir<space>
map ca push :create-archive<space>

# move and deletion of files
map m rename
map l link
map r trash
map RR delete

# Advanced file movement
map Y :copy-path-relative; echo "Paths copied to clipboard."
map D drag-and-drop
map P move-from ~/Downloads
map M rename-all
map V multi-select

# Opening and editing files
map ow open-with
map od open-with-new-default
map oe open-with-editor
map oE open-with-external-editor
map e edit

# Terminal multiplexer window mappings
map w
map ws multiplexer-window-splith
map wv multiplexer-window-splitv
map wc multiplexer-window-create

# Shells and Terminals
map t terminal
map T terminal-extern

# Different sorting for directories
setlocal ~/Downloads dirfirst false
setlocal ~/Downloads sortby time
setlocal ~/Downloads reverse true

# Add git information for the current directory
# (We don't use the recommended on-load, as it is called for every modified / created file which can cause issues and high CPU load during certain operations.)
set info custom
cmd update-git-info &{{
    shopt -s nullglob dotglob # Remove non-matching globs and match also hidden files

    # Abort early if we don't have a git directory.
    [ "$(git rev-parse --is-inside-work-tree 2>/dev/null)" = true ] || exit 0

    cmds=""

    for file in *; do
        case "$file" in
            */.git|*/.git/*) continue;;
        esac

        # The head is essentially a workaround to check directories.
        # git status only lists individual files of directories, so we simply take the first result for the directory too.
        # TODO: A better approach would probably be some kind of summary, but that is more complicated.
        status=$(git status --porcelain -- "$(realpath "$file")" | cut -c1-2 | head -n1)

        if [ -n "$status" ]; then
            cmds="${cmds}addcustominfo \"${file}\" \"$status\"; "
        else
            cmds="${cmds}addcustominfo \"${file}\" ''; "
        fi
    done

    if [ -n "$cmds" ]; then
        lf -remote "send $id :$cmds"
    fi
}}

# Setup custom status line, based on the eza color scheme
set timefmt "Mon _2 Jan 2006 15:04:05"
set rulerfile true

# Movement related functions
cmd update-prompt &lf -remote "send $id set promptfmt \" $(oh-my-posh print primary --config ~/.config/oh-my-posh-theme-powerlevel.omp.json | tail -n 1)\""
cmd update-terminal-title &lf -remote "send $id tty-write \"\033]2;${PWD/$HOME/"~"}\a\""
map <c-r> :redraw;reload;update-prompt;update-terminal-title;update-git-info

cmd pre-cd :setfilter ""
cmd on-cd :update-prompt;update-terminal-title;update-git-info
cmd on-focus-gained on-cd

cmd on-init :{{
    &[[ -n "$KITTY_WINDOW_ID" ]] && lf -remote "send $id source ~/.config/lf/kitty_commands.lf"
    &[[ -n "$TMUX" ]] && [[ -z "$KITTY_WINDOW_ID" ]] && lf -remote "send $id source ~/.config/lf/tmux_commands.lf"
    on-cd
}}
